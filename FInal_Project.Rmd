---
title: "Final_Project"
output: pdf_document
date: "2024-08-20"
---
```{r}

library(dplyr)
library(tidyr)

setwd("/Users/jainishah/Desktop/final_project_data")
gene_expression <- read.csv("genes.csv")
metadata <- read.csv("metadata.csv")

setwd("/Users/jainishah/Desktop/final_project_data")

gene_long <- gene_expression %>%
  tidyr::gather(key = "ParticipantID", value = "Expression", -X)

names(gene_long)[names(gene_long) == "X"] <- "Gene"

merged_data <- merge(gene_long, metadata, by.x = "ParticipantID", by.y = "participant_id")
head(merged_data)


clean_data <- merged_data %>%
  filter(Gene == Gene) %>%
  select(Gene, ParticipantID, Expression, age, ferritin.ng.ml., lactate.mmol.l., sex, icu_status, disease_status)


clean_data$age <- as.numeric(clean_data$age)
clean_data$ferritin.ng.ml. <- as.numeric(clean_data$ferritin.ng.ml.)
clean_data$lactate.mmol.l. <- as.numeric(clean_data$lactate.mmol.l.)
clean_data$sex <- as.factor(clean_data$sex)
clean_data$icu_status <- as.factor(clean_data$icu_status)
clean_data$disease_status <- as.factor(clean_data$disease_status)


clean_data <- na.omit(clean_data)
clean_data[clean_data == ' uknown'] <- NA 

plot_data <- clean_data %>%
  select(Gene, ParticipantID, Expression, age, ferritin.ng.ml., lactate.mmol.l., sex, icu_status, disease_status) %>% 
  filter(Gene == 'ABCA1')


```

```{r}
# Stratifying by one of your categorical variables
# Tables should report n (%) for categorical variables 
# Tables should report mean (sd) or median [IQR] for continuous variables

library(dplyr)


table_data <- clean_data %>%
  tidyr::pivot_wider(names_from = Gene, values_from = Expression) %>% 
  dplyr::select(c('age', 'ferritin.ng.ml.', 'lactate.mmol.l.', 'sex', 'icu_status', 'disease_status'))








table -cat

prop.table -cat

as.data.frame

dplyr rename freq to percent

bind_rows()

mutate

#data.analytics2 - cont. apply to columns in pos and neg

```



```{r}
# Generate final histogram, scatter plot, and boxplot from submission 1 (i.e. only for your first gene of interest) incorporating all feedback from your presentations 


# Histogram for Gene Expression
library(ggplot2)

# initializes the plot with 'final_data' and maps all 'Expression' values to the x-axis
ggplot(plot_data, aes(x = Expression)) + 
  geom_histogram(fill
                 = "pink", color = "red") +
  # plots the histogram with bars outlined and filled
  labs(title = "Histogram of Gene Expression for ABCA1", # adds title and axis labels
       x = "Gene Expression: ABCA1",
       y = "Frequency") + 
  theme_minimal() + # applied minimal theme for appearance 
  theme( # making the titles of plot and axis bold
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  )




# Scatterplot for gene expression and continuous covariate (Age)
library(ggplot2)

# initializes the plot with 'final_data' and maps all 'age' values to x-axis 'Expression' values to the y-axis
ggplot(plot_data,aes(x = age,y = Expression ,color = age)) + 
  geom_point() + 
  scale_color_gradient(low = "green", high = "blue") + # color gradient for age 
  labs(title = "Scatterplot of Gene Expression for ABCA1 vs. Age (yrs.)", # title for plot and axis 
       subtitle = "Color indicates age, ranging from green (young) to blue (old)",
       x = "Age (yrs.)",
       y = "Gene Expression: ABCA1",
       color = "Age") + 
  theme_minimal() +
  theme( # making the titles of axis and plot bold 
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5), 
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  ) +

# adding a smooth line to show trend in data 
geom_smooth(method = "loess", se = FALSE, color = "black", linetype = "dashed")





# Boxplot of gene expression separated by both categorical covariates (Sex and ICU Status)
library(ggplot2)
library(harrypotter)

# create boxplot with categorical covariates 
ggplot(plot_data,aes(x = sex ,y = Expression, fill = icu_status)) +
   geom_boxplot(outlier.shape = 12, outlier.size = 2, color = "darkgray", lwd = 0.8, alpha = 0.7) + 
    scale_fill_hp_d(option = "ronweasley") + # change border color and box details 
  facet_wrap(~ icu_status) + # separate plots by ICU status
  labs(title = "Boxplot of Gene Expression by Sex and ICU Status", # assigned titles for axis and plot 
       x = "Sex",
       y = "Gene Expression",
       fill = "ICU Status") + 
  theme_minimal(base_size = 15) + # minimal theme with font size 
  theme( # making the titles of axis and plot bold, changing placement of titles 
    plot.title = element_text(hjust = 0.125, face = "bold"),
    axis.title = element_text(face = "bold"),
    legend.title = element_text(face = "bold")
  ) 
```


```{r}
# Generate a heatmap (5 pts)
# Heatmap should include at least 10 genes
# Include tracking bars for the 2 categorical covariates in your boxplot
# Heatmaps should include clustered rows and columns 

#ask about cololring variables and changing fontsize

#install.packages("viridis")
library(pheatmap)
library(dplyr)
library(tidyr)
library(tibble)
library(viridis)

heatmap_data <- clean_data %>%
  dplyr::filter(Gene %in% c('ABCA1','ABCA2', 'ABAT', 'A2M', 'A1BG', 'AAMDC', 'ABCA8','ABCA10','ABCA7','AASS')) %>% 
  tidyr::pivot_wider(names_from = Gene, values_from = Expression)


heatmap_matrix <- heatmap_data %>%
  select(all_of(c('ABCA1', 'ABCA2', 'ABAT','A2M', 'A1BG','AAMDC','ABCA8','ABCA10','ABCA7','AASS'))) #%>%
  #as.matrix()

#heatmap_matrix <- as.data.frame(heatmap_matrix)


row.names(heatmap_matrix) <- heatmap_data$ParticipantID

heatmap_matrix <- as.data.frame(t(heatmap_matrix))

annotation_data <- heatmap_data %>%
  dplyr::select('sex', 'icu_status')


row.names(annotation_data) <- colnames(heatmap_matrix)

annotation_data <- as.data.frame(annotation_data)

table(annotation_data)


annotation_colors <- list(
  sex = c('male' = 'aquamarine4', 'female' = 'pink'),
  icu_status = c('yes' = 'royalblue', 'no' = 'deepskyblue'))

pheatmap(heatmap_matrix,
         color = viridis::turbo(500),
         annotation_col = annotation_data,
         annotation_colors = annotation_colors,
         clustering_distance_rows = 'euclidean',
         clustering_distance_cols = 'euclidean',
         clustering_method = 'complete',
         show_rownames = TRUE,
         show_colnames = FALSE,
         fontsize_row = 5,
         annotation_legend = TRUE,
         annotation_names_col = TRUE,
         main = 'Heatmap of Gene Expression with Categorical Covariates: Sex, ICU Status)')

```

```{r}
#	Going through the documentation for ggplot2, generate a plot type that we did not previously discuss in class that describes your data in a new and unique way (5 pts) 
#install.packages('gganimate')

library(ggplot2)
library(dplyr)

ggplot(clean_data, aes(x = age, y = Expression, size = ferritin.ng.ml., color = ferritin.ng.ml.)) +
  geom_point(alpha = 0.6) +
  scale_size(range = c(3, 7)) +  
  scale_color_gradient(low = 'pink', high = 'red') +
  labs(title = "Bubble Plot of Gene Expression (ABCA1) by Age and Ferritin Levels",
       x = "Age",
       y = "Gene Expression",
       size = "Ferritin (ng/ml)", 
       color = 'Ferritin (ng/mL)') +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"),
        axis.title = element_text(face = "bold"))

```


```{r}
# Submit a LaTeX file and knitted PDF file summarizing your results (20 pts total). This file should include the following sections:
#Introduction: Brief description of the data set and your gene of choice for your main plots. Additional gene descriptions aren’t required for genes included in your heatmap.
#	Methods: Brief summary of methods including data source, R version and packages, and clustering algorithm used, as discussed in class. 
#	Results: Description of the findings of each table/figure (outlined below). While you do not need to provide an extensive analysis of each item, you must provide a brief statement referencing them and then cite the relevant table or figure, as discussed in class. Example: “Gene x did not appear to be associated with covariate y (Figure 2).” Additionally, you must typeset and provide captions/figure legends for each item as discussed in class. Required elements include:
#	Table of summary statistics
#Histogram of gene
#Scatter plot of gene + continuous covariate
#Boxplot of gene stratified by 2 categorical covariates
#Heatmap
#Your selected new plot type
#References: At a minimum, your references must include the paper that the dataset came from, an original source for your gene description, and R packages used. All references should be cited within the text as shown in class.

```

